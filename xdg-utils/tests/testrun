#!/bin/bash

## Usage:
## testrun dir1 dir2 ... 
## testrun t.foo t.bar ...
## Will find and run all files in dirs that begin with t.*
usage() {
cat << _ENDUSAGE_ 
Usage:
$0 [-iIcCh] [test|testgroup] [...]

Options:
     [-h]      Show this message and exit.

     [-I|-i]   Turn off/on interactive tests. 
               (overrides XDG_TEST_NO_INTERACTIVE)
  
     [-C|-c]   Turn off/on deletion of tempfiles.
               (overrides XDG_TEST_DONT_CLEANUP)


Arguments:

After options, all arguments correspond to tests to run. The default is to run all tests, which consist of all files matching 'xdg-*/t.*'.

Supplied testgroups can be a list of directories or a list of individual tests.


_ENDUSAGE_
exit 1
}
## Set up prerequisites
if [ -z "$XDG_TEST_DIR" ] ; then
	export XDG_TEST_DIR=`pwd`
	echo "WARNING: guessed XDG_TEST_DIR to be $XDG_TEST_DIR"
fi
if [ -z `which xdg-mime` ] && [ -d "$XDG_TEST_DIR/../scripts" ] ; then
	export PATH="$PATH:$XDG_TEST_DIR/../scripts"
	echo "WARNING: modified PATH to add '$XDG_TEST_DIR/../scripts'"
fi

## Read options
while getopts "iIcCh" opt; do
	case $opt in
		I ) export XDG_TEST_NO_INTERACTIVE="set" ;;
		i ) unset XDG_TEST_NO_INTERACTIVE ;;
		C ) export XDG_TEST_DONT_CLEANUP="set" ;;
		c ) unset XDG_TEST_DONT_CLEANUP ;;
		h ) usage ;;
		\? ) usage ;;
	esac
done
shift $(($OPTIND - 1))

## Read test groups
if [ $# -eq 0 ] ; then
	TEST_GROUPS=`find "$XDG_TEST_DIR" -type d -name 'xdg-*'`
else
	TEST_GROUPS="$@"
fi

TEST_FILES=`find $TEST_GROUPS -name 't.*'`

declare -i PASS=0
declare -i TOTAL=0
TEST_LOG="$XDG_TEST_DIR/xdg-test.log"

export USING_TEST_RUNNER="true"

for t in $TEST_FILES; do
	. "$t"
done

echo "[`date`] TEST RUN START: $*" >> "$TEST_LOG"
#echo "TEST_LIST: $TEST_LIST"

for t in $TEST_LIST; do
	TOTAL=$((TOTAL + 1 ))

	echo -n "$t: "
	
	test_setup

	# Run test - subshell is necessary to keep things contained.
	( "$t" ) >> "$TEST_LOG"
	CODE="$?"

	test_cleanup

	# Report result
	if [ "$CODE" -eq 0 ] ; then
		PASS=$((PASS + 1))
		RESULT=pass
	else
		case "$CODE" in
		1 ) RESULT=FAIL;;
		5 ) RESULT=UNTESTED;;
		7 ) RESULT=NORESULT;;
		* ) RESULT="UNKNOWN($CODE)";;
		esac
		#echo  "$RESULT: $t"
	fi
	echo "$RESULT"
done
echo -n "[`date`] TEST RUN END: $* - " >> "$TEST_LOG"
echo "$PASS of $TOTAL tests passed." | tee -a "$TEST_LOG"
echo "See $TEST_LOG for details."

if [ $(( $TOTAL - $PASS )) -gt 0 ]; then
	EC=1
	echo "NOT OK!"
else
	EC=0
	echo "ok"
fi
exit "$EC"
