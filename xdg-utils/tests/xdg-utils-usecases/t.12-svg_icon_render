#!/bin/bash

. "$XDG_TEST_DIR/include/testassertions.sh"
. "$XDG_TEST_DIR/include/testcontrol.sh"

test_svg_icon_render() {

test_start "$FUNCNAME: ensure that SVG icons are rendered"


test_init

# get icon file
use_file "$XDG_TEST_DIR/icons/red-SVG.svg" ICON_FILE

# get & edit desktop file
use_file "$XDG_TEST_DIR/xdg-utils-usecases/data/icon_test.desktop" DESKTOP_FILE
edit_file "$DESKTOP_FILE" 'red' ICON_NAME

TEST_DIR="$XDG_TEST_TMPDIR"
#assert_exit 0 mkdir -p "$TEST_DIR"
#assert_exit 0 cp "$DESKTOP_FILE" "$TEST_DIR/"

test_procedure

# install icons of all sizes
assert_exit 0 xdg-icon-resource install "$ICON_FILE" "$ICON_NAME"
assert_nostdout
assert_nostderr

# Wait a little for caches to update
sleep 1

# open directory with test file
if [ `whoami` != 'root' ] ; then
	assert_exit 0 xdg-open "$TEST_DIR"
	assert_nostdout
	assert_nostderr
	assert_interactive "Did the file browser open the '$TEST_DIR' directory?" y
else
	assert_interactive "Please open '$TEST_DIR' in the file browser."
fi

# ask user to cycle through sizes & ensure correct icons are displayed.
assert_interactive "Is a file named 'Icon Test' present in the directory?" y
assert_interactive "Does the icon consist of the red text 'SVG'?\n\t(You may need to select something like 'View->As Icons')" y
# assert_interactive "Does the text change size appropriately when the display size is changed?" y

## cleanup
if [ `whoami` != 'root' ] ; then
	assert_interactive "Please close any windows opened by this test." C
else
	assert_interactive "You may close the file browser window." C
fi

# remove icons
assert_exit 0 xdg-icon-resource uninstall  "$ICON_NAME"
assert_nostdout
assert_nostderr


test_result
}

run_test test_svg_icon_render
